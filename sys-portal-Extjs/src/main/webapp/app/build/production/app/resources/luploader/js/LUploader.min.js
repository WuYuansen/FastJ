/*
 * LUploader图片压缩上传插件
 * 
 * 作者：黄磊
 * 
 * 报告漏洞，意见或建议, 请联系邮箱：xfhxbb@yeah.net
 * 
 * 创建于：2016年3月16日
 * 
 * Copyright 2016
 * 
 * 获得使用本类库的许可, 您必须保留著作权声明信息。
 */
!function(){function a(a){return"[object Array]"===Object.prototype.toString.apply(a)?!0:!1}function b(b){if("string"==typeof b)return b;var c=[],d="&";for(var e in b)if(b.hasOwnProperty(e))if(a(b[e])){for(var f=[],g=0;g<b[e].length;g++)f.push(encodeURIComponent(e)+"="+encodeURIComponent(b[e][g]));f.length>0&&c.push(f.join(d))}else c.push(encodeURIComponent(e)+"="+encodeURIComponent(b[e]));return c.join(d)}function c(a){for(var b={},c=0;c<a.attributes.length;c++){var e=a.attributes[c];e.name.indexOf("data-")>=0&&(b[d(e.name.split("data-")[1])]=e.value)}return b}function d(a){return a.toLowerCase().replace(/-(.)/g,function(a,b){return b.toUpperCase()})}window.LUploader=function(a,b){var c=this;c.trigger=a,c.params={accept:"image/*",multiple:!1,maxsize:102400,imgObj:{},showsize:!1,quality:.1,url:""};for(var d in b)c.params[d]=b[d];c.init()},LUploader.prototype.init=function(){var a=this;a.trigger.setAttribute("accept",a.params.accept),a.params.multiple&&a.trigger.setAttribute("multiple","");var b=document.querySelector("#"+a.trigger.getAttribute("data-LUploader"));b.addEventListener("click",function(){a.trigger.click()}),a.trigger.addEventListener("change",function(){if(this.files.length){var b=Array.prototype.slice.call(this.files);b.forEach(function(b,d){if(/\/(?:jpeg|png|gif)/i.test(b.type)){var e=new FileReader;a.params.imgObj.size=b.size/1024>1024?~~(10*b.size/1024/1024)/10+"MB":~~(b.size/1024)+"KB";var f=document.createElement("li");if(f.innerHTML='<div class="LUploader-progress"><span></span></div>',a.params.showsize){var g=document.createElement("div");g.className="LUploader-size",g.textContent=a.params.imgObj.size,f.appendChild(g)}var h=a.trigger.parentElement.querySelector(".LUploader-list");a.params.multiple||(a.old_li?h.removeChild(a.old_li):a.old_li=f),h.appendChild(f),h.parentElement.nextElementSibling.style.display="none",e.onload=function(){function d(){var c=a.compress(i);a.upload(g,e,c,b.type,f),i=null}var e=c(a.trigger),g=a.params.url,h=this.result,i=new Image;return a.params.imgObj.src=i.src=h,f.style["background-image"]="url("+h+")",h.length<=a.params.maxsize?(i=null,void a.upload(g,e,h,b.type,f)):void(i.complete?d():i.onload=d)},e.readAsDataURL(b)}})}})},LUploader.prototype.compress=function(a){var b,c=document.createElement("canvas"),d=c.getContext("2d"),e=document.createElement("canvas"),f=e.getContext("2d"),g=a.width,h=a.height;(b=g*h/4e6)>1?(b=Math.sqrt(b),g/=b,h/=b):b=1,c.width=g,c.height=h,d.fillStyle="#fff",d.fillRect(0,0,c.width,c.height);var i;if((i=g*h/1e6)>1){i=~~(Math.sqrt(i)+1);var j=~~(g/i),k=~~(h/i);e.width=j,e.height=k;for(var l=0;i>l;l++)for(var m=0;i>m;m++)f.drawImage(a,l*j*b,m*k*b,j*b,k*b,0,0,j,k),d.drawImage(e,l*j,m*k,j,k)}else d.drawImage(a,0,0,g,h);var n=c.toDataURL("image/jpeg",this.params.quality);return e.width=e.height=c.width=c.height=0,n},LUploader.prototype.upload=function(a,c,d,e,f){for(var g=window.atob(d.split(",")[1]),h=new Uint8Array(g.length),i=0,j=0;j<g.length;j++)h[j]=g.charCodeAt(j);var k=f.querySelector(".LUploader-progress").querySelector("span"),l=new XMLHttpRequest;l.open("post",a),l.onload=function(a){if(l.status>=200&&l.status<300||0===l.status){var b=JSON.parse(l.responseText),c=b.status,d=0==c?"上传成功":"上传失败";k.style.width="100%",k.innerHTML=d}else k.innerHTML="上传失败"},l.upload.addEventListener("progress",function(a){i=~~(100*a.loaded/a.total),k.style.width=i+"%",k.innerHTML=(100==i?99:i)+"%"},!1);var m={};for(var n in c)"luploader"!==n&&("basestr"==c[n]?m[n]=d:m[n]=c[n]);m=b(m),l.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.send(m)}}();
/*! 最后修改于： 2016-03-23  05:49:34 */